{% extends "base.html" %}
{% load static %}

{% block extra_css %}

<link rel="stylesheet" href="{% static 'dashboard/dashboard.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* SIDEBAR */
.sidebar {
    width: 240px;
    height: 100vh;
    background: #1d3557;
    color: white;
    position: fixed;
    top: 0;
    left: 0;
    padding-top: 25px;
    display: flex;
    flex-direction: column;
}

.sidebar h2 {
    font-size: 22px;
    text-align: center;
    margin-bottom: 30px;
    font-weight: 800;
}

.sidebar a {
    padding: 14px 22px;
    display: flex;
    align-items: center;
    gap: 12px;
    color: #cbd5e1;
    text-decoration: none;
    font-size: 15px;
    transition: .2s;
}

.sidebar a:hover,
.sidebar a.active {
    background: #457b9d;
    color: white;
}

/* NAVBAR */
.navbar-custom {
    margin-left: 240px;
    height: 60px;
    background: white;
    display: flex;
    align-items: center;
    padding: 0 25px;
    justify-content: space-between;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.navbar-custom .user {
    font-weight: 600;
    color: #1d3557;
}

/* CONTENT */
.main-content {
    margin-left: 240px;
    padding: 25px 35px;
}

.section-title {
    font-size: 22px;
    font-weight: 800;
    margin-bottom: 18px;
    color: #1d3557;
}
</style>
{% endblock %}

{% block content %}

<!-- SIDEBAR -->
<div class="sidebar">
    <h2>FINTECH BI</h2>

    <a href="{% url 'dashboard' %}" class="active">
        <i class="bi bi-speedometer2"></i> Dashboard
    </a>

    <a href="#">
        <i class="bi bi-cash-stack"></i> Transactions
    </a>

    <a href="#">
        <i class="bi bi-receipt"></i> Invoices
    </a>

    <a href="#">
        <i class="bi bi-credit-card"></i> Comptes
    </a>

    <a href="#">
        <i class="bi bi-gear"></i> Paramètres
    </a>
</div>

<!-- NAVBAR -->
<div class="navbar-custom">
    <span class="fs-5 fw-bold">Dashboard financier</span>

    <div class="user">
        Bonjour, {{ user.first_name|default:user.username }}
    </div>
</div>

<!-- PAGE CONTENT -->
<div class="main-content">

    <!-- FILTRES -->
    <div class="filter-box">
        <form method="get" class="d-flex gap-3">
            <input type="date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
            <input type="date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
            
            <select name="t_type" class="form-select">
                <option value="">Type transaction</option>
                <option value="deposit">Dépôt</option>
                <option value="withdrawal">Retrait</option>
            </select>

            <button class="btn btn-primary">
                <i class="bi bi-funnel"></i> Filtrer
            </button>
        </form>
    </div>

    <!-- KPI -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-title">Solde total</div>
            <div class="kpi-value">{{ summary.total_balance|floatformat:0 }} FCFA</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-title">Revenus</div>
            <div class="kpi-value text-success">+{{ summary.total_income|floatformat:0 }} FCFA</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-title">Dépenses</div>
            <div class="kpi-value text-danger">-{{ summary.total_expenses|floatformat:0 }} FCFA</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-title">Factures en attente</div>
            <div class="kpi-value">{{ summary.pending_invoices }}</div>
        </div>
    </div>

    <!-- GRAPHIQUES -->
    <div class="charts-grid">
        <div class="chart-box">
            <h3 class="section-title"><i class="bi bi-graph-up"></i> Évolution du solde</h3>
            <canvas id="balanceChart"></canvas>
        </div>

        <div class="chart-box">
            <h3 class="section-title"><i class="bi bi-bar-chart"></i> Distribution comptes</h3>
            <canvas id="accountsChart"></canvas>
        </div>
    </div>

    <!-- TABLES -->
    <div class="tables-grid">
        
        <div>
            <h3 class="section-title"><i class="bi bi-arrow-left-right"></i> Transactions récentes</h3>
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Montant</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tr in recent_transactions %}
                    <tr>
                        <td>{{ tr.transaction_type }}</td>
                        <td>{{ tr.description }}</td>
                        <td>{{ tr.amount }} FCFA</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center py-4">Aucune transaction</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div>
            <h3 class="section-title"><i class="bi bi-receipt"></i> Factures récentes</h3>
            <table>
                <thead>
                    <tr>
                        <th>Numéro</th>
                        <th>Client</th>
                        <th>Montant</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inv in invoices %}
                    <tr>
                        <td>{{ inv.invoice_number }}</td>
                        <td>{{ inv.customer }}</td>
                        <td>{{ inv.amount }} FCFA</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center py-4">Aucune facture</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const chartData = {{ chart_data|safe }};

// Balance evolution
new Chart(document.getElementById("balanceChart"), {
    type: 'line',
    data: {
        labels: chartData.labels,
        datasets: [{
            label: "Solde",
            data: chartData.balance,
            borderWidth: 3,
            tension: 0.4
        }]
    }
});

// Accounts distribution
new Chart(document.getElementById("accountsChart"), {
    type: 'bar',
    data: {
        labels: chartData.accounts_labels,
        datasets: [{
            label: "Comptes",
            data: chartData.accounts_values,
            borderWidth: 1
        }]
    }
});
</script>

{% endblock %}
